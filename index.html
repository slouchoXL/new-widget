<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Packs Widget</title>
  <link rel="stylesheet" href="style.css">

  <style>
    html, body { overflow-x: hidden; }
  </style>

  <!-- Supabase SDK -->
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>

  <!-- Supabase project config -->
  <script>
    window.__SUPABASE_URL = 'https://srdwkfjterotzjwzoauj.supabase.co';
    window.__SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNyZHdrZmp0ZXJvdHpqd3pvYXVqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTU4NjU5NTksImV4cCI6MjA3MTQ0MTk1OX0.c0mJbQsfJMmqLiulXdZfWscd7J507buzRXkd700ymAQ';
  </script>

  <!-- Backend base (define BEFORE app.js) -->
  <script>
    (function () {
      const params = new URLSearchParams(location.search);
      let apiBase = params.get('api') || 'https://backend-o9ot.onrender.com';
      apiBase = String(apiBase || '').trim()
        .replace(/\/+$/,'')
        .replace(/\/api$/i, '');
      window.__PACKS_API_BASE = apiBase; // e.g. "https://backend-o9ot.onrender.com"
    })();
  </script>

  <div id="auth">
    <input type="email" id="emailInput" placeholder="Enter email" />
    <button id="loginBtn">Send Magic Link</button>
    <button id="logoutBtn" hidden>Log out</button>
  </div>

  <script>
    const emailInput = document.getElementById('emailInput');
    const loginBtn = document.getElementById('loginBtn');
    const logoutBtn = document.getElementById('logoutBtn');

    loginBtn.addEventListener('click', async () => {
      const email = emailInput.value.trim();
      if (!email) return alert('Enter your email');
      const { error } = await supabase.auth.signInWithOtp({ email });
      if (error) alert(error.message);
      else alert('Check your email for the magic link!');
    });

    logoutBtn.addEventListener('click', async () => {
      await supabase.auth.signOut();
      alert('Logged out');
      loginBtn.hidden = false;
      logoutBtn.hidden = true;
    });

    supabase.auth.onAuthStateChange((event, session) => {
      console.log('[auth event]', event, session);
      if (session?.user) {
        loginBtn.hidden = true;
        logoutBtn.hidden = false;
      } else {
        loginBtn.hidden = false;
        logoutBtn.hidden = true;
      }
    });
  </script>
  
  <!-- Your app (module so we can use top-level await) -->
  <script type="module" src="app.js"></script>
</head>
<body>
  <div id="app" class="widget" aria-live="polite">
    <div class="topbar">
      <div class="meta">
        <div class="balance" id="balance">Balance: —</div>
        <div class="price"   id="price">Price: —</div>
      </div>
    </div>

    <div class="stage">
      <div class="anchor">
        <img class="pack-img" src="./assets/pack.png" alt="Pack" id="packImg" />
        <div class="stack" id="stack" hidden></div>
        <div class="tray"  id="tray"  hidden></div>

        <!-- overlay lives INSIDE the stage so it appears on top (not below) -->
        <div id="overlay" class="overlay" hidden>
          <div class="overlay-backdrop"></div>
          <div class="overlay-card">
            <img id="overlay-img" alt="" />
          </div>
        </div>
      </div>
    </div>

    <div class="actions">
      <button id="cta" class="btn">Open Packs</button>
    </div>

    <div id="error" class="error" hidden></div>
  </div>

  <!-- Resize notifier for parent iframe (optional) -->
  <script>
    (function () {
      function postHeight(){
        const h = Math.max(
          document.documentElement.scrollHeight,
          document.body ? document.body.scrollHeight : 0
        );
        if (window.parent && window.parent !== window){
          window.parent.postMessage({ type: 'packs:height', height: h }, '*');
        }
      }
      window.addEventListener('load', postHeight);
      window.addEventListener('resize', postHeight);
      const mo = new MutationObserver(() => postHeight());
      mo.observe(document.documentElement, { childList:true, subtree:true, attributes:true });
      postHeight();
    })();
  </script>
</body>
</html>
